name: Security & Real-Time Checks

on:
  push:
    branches: [ master, main, develop, rostik ]
  pull_request:
    branches: [ master, main, develop ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  MIRIFLAGS: -Zmiri-strict-provenance -Zmiri-symbolic-alignment-check

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rustsec/audit-check-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  deny:
    name: Cargo Deny
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: EmbarkStudios/cargo-deny-action@v1

  miri:
    name: Undefined Behavior Detection (Miri)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
        with:
          components: miri
      - uses: Swatinem/rust-cache@v2
      - run: cargo miri test --all-features
        continue-on-error: true

  no-allocations:
    name: Check No-Allocations (Hard Real-Time)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Check for forbidden patterns in timing-critical code
        run: |
          $forbidden_patterns = @(
            '\.unwrap\(\)',
            '\.expect\(',
            'vec!\[',
            'HashMap::new\(\)',
            'thread::spawn'
          )
          
          $found_issues = $false
          foreach ($pattern in $forbidden_patterns) {
            $matches = Get-ChildItem -Path "src" -Filter "*.rs" -Recurse | 
              Select-String -Pattern $pattern | 
              Where-Object { $_ -notmatch 'test|SAFETY:' }
            
            if ($matches) {
              Write-Host "❌ Found $pattern in timing-critical paths:"
              $matches | ForEach-Object { Write-Host "  $_" }
              $found_issues = $true
            }
          }
          
          if ($found_issues) {
            exit 1
          } else {
            Write-Host "✅ Code follows hard real-time guidelines"
          }
      
  telemetry-check:
    name: Telemetry Interface Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Verify telemetry abstractions
        run: |
          Write-Host "Checking for proper telemetry abstractions..."
          if (Test-Path "src/telemetry" -PathType Container) {
            Write-Host "✅ Telemetry module found"
          } else {
            Write-Host "⚠️  Telemetry module not yet implemented"
          }
          
          Write-Host "Verifying modular component structure..."
          $expected_modules = @("telemetry", "hal", "scheduler")
          foreach ($module in $expected_modules) {
            if (Test-Path "src/$module" -PathType Container) {
              Write-Host "✅ $module module found"
            }
          }
